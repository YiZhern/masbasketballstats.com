<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Advanced Weight Calculator</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
</head>
<body>
  <!-- nav bar -->
  <div class="top-nav">
    <div class="left-section">
      <a href="https://www.maba.com.my" target="_blank" style="color: #333; text-decoration: none;">MABA</a>
      <span>FIBA</span>
    </div>
    <div class="right-section">
      <span>Listen</span>
      <span>Search üîç</span>
      <span>üë§</span>
    </div>
  </div>
  
  <!-- Sub-nav with dropdown -->
  <div class="sub-nav">
    <a href="index.html">Home</a>
    <a href="historical.html">Historical Stats</a>
    <a href="calculator.html">Advanced Calculator</a>
    <div class="dropdown">
      <a href="#" class="dropbtn">Competition ‚ñº</a>
      <div class="dropdown-content">
        <a href="#">MABA Cup</a>
        <a href="#">National U17</a>
        <a href="#">National U15</a>
        <a href="#">Agong Cup</a>
      </div>
    </div>
  </div>

  <div class="container">
    <h1>Weighted Rankings</h1>

    <div class="filter-bar">
      <label>Competition:</label>
      <select id="competitionSelect" multiple size="3">
        <option>All</option>
        <option>U15 (Boys)</option>
        <option>U17 (Boys)</option>
      </select>

      <label>Year:</label>
      <select id="yearSelect" multiple size="3">
        <option>All</option>
        <option>2024</option>
        <option>2025</option>
      </select>
    </div>

    <div class="weight-panel">
      <h2>Weight Allocation</h2>
      <div class = "stats-chip">
        <div class="chip" data-value="fg">FG%</div>
        <div class="chip" data-value="fg2">2FG%</div>
        <div class="chip" data-value="fg3">3FG%</div>
        <div class="chip" data-value="ft">FT%</div>
        <div class="chip" data-value="oreb">OffRebs</div>
        <div class="chip" data-value="dreb">DefRebs</div>
        <div class="chip" data-value="treb">TotRebs</div>
        <div class="chip" data-value="as">Assists</div>
        <div class="chip" data-value="to">Turnovers</div>
        <div class="chip" data-value="st">Steals</div>
        <div class="chip" data-value="bs">Blocks</div>
        <div class="chip" data-value="pf">Personal Fouls</div>
        <div class="chip" data-value="fd">Fouls Drawn</div>
        <div class="chip" data-value="pts">PTS</div>
      </div>
    </div>

      <div class="name-input">
        <label>Allocation Name:
          <input type="text" id="allocName" placeholder="Scoring Focus">
        </label>
      </div>

      <div id="sliderContainer"></div>

      <button id="generateBtn">Generate Rankings</button>

      <h2 id="rankingTitle"></h2>
      <div class="table-wrapper">
        <table id="rankingTable">
          <thead>
            <tr><th>Player</th><th>Team</th><th>Score</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

<script>
let originalData = [];

// Utility to safely divide
function safeDivide(n, d) {
  return d === 0 ? 0 : n / d;
}

// Fetch and parse CSV data
fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTdFDyDmOtmFl1uhz2ZJkhb0rb6BjWabVdhvrwn6DZ9DRAhEdwKhvkZ_dGQVwBrs1qrTtJQiHf-JEyU/pub?output=csv')
  .then(r => r.text())
  .then(csv => {
    const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true }).data;
    originalData = parsed.map(r => ({
      player: r.Player,
      competition: r.Competition,
      year: r.Year,
      team: r.Team,
      gp: +r.GP,
      min: +r['Min'],
      fga: +r.FGA,
      fgm: +r.FGM,
      fga2: +r['2FGA'],
      fgm2: +r['2FGM'],
      fga3: +r['3FGA'],
      fgm3: +r['3FGM'],
      fta: +r.FTA,
      ftm: +r.FTM,
      oreb: +r.OR,
      dreb: +r.DR,
      treb: +r.TR,
      as: +r.AS,
      to: +r.TO,
      st: +r.ST,
      bs: +r.BS,
      pf: +r.PF,
      fd: +r.FD,
      pts: +r.PTS,
      fg: safeDivide(+r.FGM, +r.FGA),
      fg2: safeDivide(+r['2FGM'], +r['2FGA']),
      fg3: safeDivide(+r['3FGM'], +r['3FGA']),
      ft: safeDivide(+r.FTM, +r.FTA)
    }));
    populateCompetitionOptions();
  })
  .catch(err => {
    console.error("Error loading CSV:", err);
    alert("Failed to load player data.");
  });

function populateCompetitionOptions() {
  const sel = document.getElementById('competitionSelect');
  sel.innerHTML = '<option>All</option>';
  [...new Set(originalData.map(p => p.competition))].forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  });
}

function getSelectValues(sel) {
  return [...sel.selectedOptions].map(o => o.value);
}

function getSelectedStats() {
  return [...document.querySelectorAll('input[name="stat"]:checked')].map(c => c.value);
}

function renderSliders() {
  const stats = getSelectedStats();
  const container = document.getElementById('sliderContainer');
  container.innerHTML = '';
  if (!stats.length) return;

  container.innerHTML = '<h3>Weight Allocation (Total =‚ÄØ100%)</h3>';
  stats.forEach(s => {
    const init = Math.floor(100 / stats.length);
    container.insertAdjacentHTML('beforeend', `
      <label style="display:flex; justify-content:space-between; margin-bottom:8px;">
        ${s.toUpperCase()}:
        <input type="range" name="w_${s}" min="0" max="100" value="${init}" oninput="rebalance('${s}')">
        <span>${init}</span>%
      </label>
    `);
  });
  container.style.display = 'block';
  updateLabels();
}

function rebalance(changed) {
  const sliders = document.querySelectorAll('#sliderContainer input[type="range"]');
  const changedSlider = document.querySelector(`[name="w_${changed}"]`);
  const changedVal = +changedSlider.value;
  const others = [...sliders].filter(slider => slider !== changedSlider);
  let remaining = 100 - changedVal;
  const sumOthers = others.reduce((sum, s) => sum + +s.value, 0);

  if (sumOthers === 0) {
    const even = Math.floor(remaining / others.length);
    others.forEach(s => s.value = even);
  } else {
    others.forEach(s => {
      const ratio = +s.value / sumOthers;
      s.value = Math.round(ratio * remaining);
    });
  }

  const total = [...sliders].reduce((sum, s) => sum + +s.value, 0);
  if (total !== 100) {
    const delta = 100 - total;
    others[0].value = +others[0].value + delta;
  }

  updateLabels();
}

function updateLabels() {
  document.querySelectorAll('#sliderContainer input[type="range"]').forEach(inp => {
    inp.nextElementSibling.textContent = inp.value;
  });
}

function generateRanking() {
  const comps = getSelectValues(document.getElementById('competitionSelect'));
  const years = getSelectValues(document.getElementById('yearSelect'));
  const stats = getSelectedStats();

  if (!stats.length) return alert('Select at least one stat.');

  const weights = {};
  document.querySelectorAll('#sliderContainer input[type=range]').forEach(inp => {
    const stat = inp.name.replace('w_', '');
    weights[stat] = (stat === 'to' || stat === 'pf') ? -inp.value / 100 : +inp.value / 100;
  });

  const filtered = originalData.filter(p =>
    p.gp > 0 &&
    (!comps.includes('All') ? comps.includes(p.competition) : true) &&
    (!years.includes('All') ? years.includes(p.year) : true)
  );

  const results = filtered.map(p => ({
    player: p.player,
    team: p.team,
    score: stats.reduce((sum, s) => sum + (p[s] || 0) * weights[s] / p.gp, 0)
  }))
  .sort((a, b) => b.score - a.score)
  .slice(0, 10);

  document.getElementById('rankingTitle').textContent =
    document.getElementById('allocName').value.trim() || 'Ranking';

  const tbody = document.querySelector('#rankingTable tbody');
  tbody.innerHTML = results
    .map(r => `<tr><td>${r.player}</td><td>${r.team}</td><td>${r.score.toFixed(2)}</td></tr>`)
    .join('');
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.chip').forEach(chip => {
    const value = chip.dataset.value;
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.name = 'stat';
    checkbox.value = value;
    checkbox.style.display = 'none';
    chip.appendChild(checkbox);

    chip.addEventListener('click', () => {
      chip.classList.toggle('selected');
      checkbox.checked = chip.classList.contains('selected');
      renderSliders();
    });
  });

  document.getElementById('generateBtn').addEventListener('click', generateRanking);
});
</script>
</body>
</html>
