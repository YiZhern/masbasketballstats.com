<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Advanced Weight Calculator</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    .weight-group { margin-bottom:20px; background:#222; padding:15px; border-radius:8px; }
    .weight-group h3 { margin-top:0; color:#FFA500; }
    .weight-group label { display:flex; justify-content:space-between; margin:5px 0; }
    .weight-group input { width:80px; text-align:center; }
    #generateBtn { background:#FFA500; }
    table { margin-bottom:30px; }
  </style>
</head>
<body>
  <!-- nav bar -->
  <div class="top-nav">
    <div class="left-section">
      <a href="https://www.maba.com.my" target="_blank" style="color: #333; text-decoration: none;">MABA</a>
      <span>FIBA</span>
    </div>
    <div class="right-section">
      <span>Listen</span>
      <span>Search üîç</span>
      <span>üë§</span>
    </div>
  </div>
  
  <!-- Sub-nav with dropdown -->
  <div class="sub-nav">
    <a href="index.html">Home</a>
    <a href="historical.html">Historical Stats</a>
    <a href="calculator.html">Advanced Calculator</a>
    <div class="dropdown">
      <a href="#" class="dropbtn">Competition ‚ñº</a>
      <div class="dropdown-content">
        <a href="#">MABA Cup</a>
        <a href="#">National U17</a>
        <a href="#">National U15</a>
        <a href="#">Agong Cup</a>
      </div>
    </div>
  </div>
  
  <div class="container">
    <h1>Weighted Position Calculator</h1>
    
    <div class="filter-bar">
      <label>Competition:
        <select id="competitionSelect" onchange="updateYears()"><option>All</option><option>U15 (Boys)</option><option>U17 (Boys)</option><option>MABA Cup</option><option>Agong Cup</option></select>
      </label>
      <label>Year:
        <select id="yearSelect"><option>All</option><option>2024</option><option>2025</option></select>
      </label>
    </div>

  <div class="weight-panel">
    <h2>Weight Allocation</h2>
    <div class = 'row-wrapper'>
      <!-- POINT GUARD -->
      <div class="position-group">
        <h3>Point Guard</h3>
        <div class="slider-group" id="pg-weights">
          <label>PTS <input name="pg_pts" type="range" min="0" max="100" value="40" oninput="updateWeightAutoAdjusted(this, 'pg')"> <span>40</span>%</label> 
          <label>AST <input name="pg_as" type="range" min="0" max="100" value="40" oninput="updateWeightAutoAdjusted(this, 'pg')"> <span>40</span>%</label>
          <label>FGA <input name="pg_fga" type="range" min="0" max="100" value="10" oninput="updateWeightAutoAdjusted(this, 'pg')"> <span>10</span>%</label> 
          <label>TOS <input name="pg_to" type="range" min="0" max="100" value="10" oninput="updateWeightAutoAdjusted(this, 'pg')"> <span>10</span>%</label>
        </div>
        <p>Total: <span id="pg-total">100</span>%</p>
      </div>
    
      <!-- WINGS -->
      <div class="position-group">
        <h3>Wings</h3>
        <div class="slider-group" id="wg-weights">
          <label>PTS <input name="wg_pts" type="range" min="0" max="100" value="10" oninput="updateWeightAutoAdjusted(this, 'wg')"> <span>10</span>%</label> 
          <label>AST <input name="wg_as" type="range" min="0" max="100" value="40" oninput="updateWeightAutoAdjusted(this, 'wg')"> <span>40</span>%</label>
          <label>FGA <input name="wg_fga" type="range" min="0" max="100" value="10" oninput="updateWeightAutoAdjusted(this, 'wg')"> <span>10</span>%</label> 
          <label>TOS <input name="wg_to" type="range" min="0" max="100" value="40" oninput="updateWeightAutoAdjusted(this, 'wg')"> <span>40</span>%</label>
        </div>
        <p>Total: <span id="wg-total">100</span>%</p>
      </div>
    </div>

    <div class = 'row-wrapper'>  
      <!-- CENTER -->
      <div class="position-group">
        <h3>Center</h3>
        <div class="slider-group" id="center-weights">
          <label>PTS <input name="center_pts" type="range" min="0" max="100" value="40" oninput="updateWeightAutoAdjusted(this, 'center')"> <span>40</span>%</label> 
          <label>AST <input name="center_as" type="range" min="0" max="100" value="10" oninput="updateWeightAutoAdjusted(this, 'center')"> <span>10</span>%</label>
          <label>FGA <input name="center_fga" type="range" min="0" max="100" value="10" oninput="updateWeightAutoAdjusted(this, 'center')"> <span>10</span>%</label> 
          <label>TOS <input name="center_to" type="range" min="0" max="100" value="40" oninput="updateWeightAutoAdjusted(this, 'center')"> <span>40</span>%</label>
        </div>
        <p>Total: <span id="center-total">100</span>%</p>
      </div>
    
      <!-- DEFENSIVE -->
      <div class="position-group">
        <h3>Defensive</h3>
        <div class="slider-group" id="def-weights">
          <label>PTS <input name="def_pts" type="range" min="0" max="100" value="10" oninput="updateWeightAutoAdjusted(this, 'def')"> <span>10</span>%</label> 
          <label>AST <input name="def_as" type="range" min="0" max="100" value="10" oninput="updateWeightAutoAdjusted(this, 'def')"> <span>10</span>%</label>
          <label>FGA <input name="def_fga" type="range" min="0" max="100" value="40" oninput="updateWeightAutoAdjusted(this, 'def')"> <span>40</span>%</label> 
          <label>TOS <input name="def_to" type="range" min="0" max="100" value="40" oninput="updateWeightAutoAdjusted(this, 'def')"> <span>40</span>%</label>
        </div>
        <p>Total: <span id="def-total">100</span>%</p>
      </div>
    </div>
  
    <button id="generateBtn">Generate Rankings</button>
    <div id="errorMsg" style="color:#f55; margin:10px 0;"></div>
    <div id="rankingMatrix"></div>
  </div>

    
  <script>
    let originalData = [];
    fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTdFDyDmOtmFl1uhz2ZJkhb0rb6BjWabVdhvrwn6DZ9DRAhEdwKhvkZ_dGQVwBrs1qrTtJQiHf-JEyU/pub?output=csv')
      .then(r => r.text()).then(csv => {
        Papa.parse(csv, { header:true, skipEmptyLines:true }).data.forEach(r => {
          originalData.push({
            player:r['Player'], competition:r['Competition'], year:parseInt(r['Year']),
            team:r['Team'], pts:+r['PTS'], as:+r['AS'], fgm:+r['FGM'], reb:+r['TR'],
            st:+r['ST'], bs:+r['BS'], to:+r['TO'], pf:+r['PF']
          });
        });
      });

    function sumWeights(prefix) {
      return ['fga','fgm','fga2','fgm2','fga3','fgm3','fta','ftm','oreb','dreb','treb','as','to','st','bs','pf','fd','pts']
        .reduce((s, stat) => {
          const el = document.querySelector(`input[name="${prefix}_${stat}"]`);
          return el ? s + Number(el.value) : s;
        },0);
    }

    function readWeights(prefix, stats) {
      const w = {};
      let total = 0;
      stats.forEach(stat => {
        const val = Number(document.querySelector(`input[name="${prefix}_${stat}"]`).value);
        w[stat] = val;
        total += val;
      });
      return stats.map(stat => [stat, w[stat] / total]);
    }

    function validateAll() {
      const groups = ['pg','wg','center','def'];
      let ok = true;
      groups.forEach(g => {
        const s = sumWeights(g);
        document.getElementById(`${g}-total`).textContent = s;
        if (s !== 100) ok = false;
      });
      return ok;
    }

    function calculateScore(p, weights) {
      return weights.reduce((sum, [stat, w]) => sum + (p[stat]||0)*w, 0);
    }

    function generate() {
      document.getElementById('errorMsg').textContent = '';
      if (!validateAll()) {
        document.getElementById('errorMsg').textContent = '‚ö†Ô∏è Each group must sum to 100.';
        return;
      }

      const comp = document.getElementById('competitionSelect').value;
      const year = document.getElementById('yearSelect').value;
      let data = originalData.slice();
      if (comp !== 'All') data = data.filter(p => p.competition === comp);
      if (year !== 'All') data = data.filter(p => p.year.toString() === year);

      const config = {
        pg: readWeights('pg',['pts','as','fga','to']),
        wg: readWeights('wg',['pts','as','fga','to']),
        center: readWeights('center',['pts','as','fga','to']),
        def:    readWeights('def',['pts','as','fga','to'])
      };

      const container = document.getElementById('rankingMatrix');
      container.innerHTML = '';
      ['pg','wg','center','def'].forEach(pos => {
        const weights = config[pos];
        const sorted = data.map(p => ({
          player:p.player, team:p.team, score:calculateScore(p,weights)
        })).sort((a,b)=>b.score-a.score).slice(0,10);

        const tbl = document.createElement('table');
        tbl.innerHTML = `
          <thead><tr><th>${pos.toUpperCase()}</th><th>Team</th><th>Score</th></tr></thead>
          <tbody>${sorted.map(p=>`
            <tr><td>${p.player}</td><td>${p.team}</td><td>${p.score.toFixed(2)}</td></tr>`).join('')}</tbody>`;
        container.appendChild(tbl);
      });
    }

    function updateWeightAutoAdjusted(input, group) {
      const sliders = Array.from(document.querySelectorAll(`#${group}-weights input[type="range"]`));
      const total = 100;
      const movedSlider = input;
      const movedValue = parseInt(movedSlider.value);
      const others = sliders.filter(s => s !== movedSlider);
      let remaining = total - movedValue;
    
      if (remaining < 0) remaining = 0; // Prevent negative weights
    
      const sumOthers = others.reduce((sum, s) => sum + parseInt(s.value), 0);
    
      if (sumOthers === 0) {
        // Distribute remaining equally
        const share = Math.floor(remaining / others.length);
        others.forEach(s => s.value = share);
      } else {
        // Redistribute proportionally
        others.forEach(s => {
          const val = parseInt(s.value);
          const ratio = val / sumOthers;
          s.value = Math.round(ratio * remaining);
        });
      }
    
      // Rounding fix to make sure total is exactly 100
      let checkTotal = sliders.reduce((sum, s) => sum + parseInt(s.value), 0);
      if (checkTotal !== 100 && others.length > 0) {
        const delta = 100 - checkTotal;
        const adj = others[0];
        adj.value = parseInt(adj.value) + delta;
      }
    
      sliders.forEach(s => s.nextElementSibling.textContent = s.value);
      document.getElementById(`${group}-total`).textContent = "100";
      document.getElementById(`${group}-total`).style.color = 'green';
    }

    document.getElementById('generateBtn').onclick = generate;
    ['pg','wg','center','def'].forEach(g => {
      ['fga','fgm','fga2','fgm2','fga3','fgm3','fta','ftm','oreb','dreb','treb','as','to','st','bs','pf','fd','pts'].forEach(stat => {
        const el = document.querySelector(`input[name="${g}_${stat}"]`);
        if (el) {
          el.oninput = function () {
            updateWeightAutoAdjusted(this, g);
            document.getElementById(`sum_${g}`).textContent = sumWeights(g);
          };
        }
      });
    });
  </script>
</body>
</html>
