<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Advanced Weight Calculator</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    .weight-group { margin-bottom:20px; background:#222; padding:15px; border-radius:8px; }
    .weight-group h3 { margin-top:0; color:#FFA500; }
    .weight-group label { display:flex; justify-content:space-between; margin:5px 0; }
    .weight-group input { width:80px; text-align:center; }
    #generateBtn { background:#FFA500; }
    table { margin-bottom:30px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Weighted Position Calculator</h1>
    
    <div class="filter-bar">
      <label>Competition:
        <select id="competitionSelect"><option>All</option><option>U15 (Boys)</option><option>U17 (Boys)</option><option>MABA Cup</option><option>Agong Cup</option></select>
      </label>
      <label>Year:
        <select id="yearSelect"><option>All</option><option>2024</option><option>2025</option></select>
      </label>
    </div>
    
    <div id="weightsContainer">
      <div class="weight-group" id="guardGroup">
        <h3>Guard Weights (Total = 100)</h3>
        <label>PTS: <input type="number" name="guard_pts" value="30" min="0" max="100"/></label>
        <label>AS:  <input type="number" name="guard_as" value="30" min="0" max="100"/></label>
        <label>FGM: <input type="number" name="guard_fgm" value="20" min="0" max="100"/></label>
        <label>TO:  <input type="number" name="guard_to" value="20" min="0" max="100"/></label>
        <div>Sum: <span id="sum_guard">100</span></div>
      </div>

      <div class="weight-group" id="wingsGroup">
        <h3>Wings Weights (Total = 100)</h3>
        <label>PTS: <input type="number" name="wings_pts" value="25" min="0" max="100"/></label>
        <label>REB: <input type="number" name="wings_reb" value="25" min="0" max="100"/></label>
        <label>FGM: <input type="number" name="wings_fgm" value="25" min="0" max="100"/></label>
        <label>ST:  <input type="number" name="wings_st" value="25" min="0" max="100"/></label>
        <div>Sum: <span id="sum_wings">100</span></div>
      </div>

      <div class="weight-group" id="centerGroup">
        <h3>Center Weights (Total = 100)</h3>
        <label>REB: <input type="number" name="center_reb" value="30" min="0" max="100"/></label>
        <label>BS:  <input type="number" name="center_bs" value="30" min="0" max="100"/></label>
        <label>PTS: <input type="number" name="center_pts" value="20" min="0" max="100"/></label>
        <label>PF:  <input type="number" name="center_pf" value="20" min="0" max="100"/></label>
        <div>Sum: <span id="sum_center">100</span></div>
      </div>

      <div class="weight-group" id="defGroup">
        <h3>Defensive Weights (Total = 100)</h3>
        <label>ST: <input type="number" name="def_st" value="40" min="0" max="100"/></label>
        <label>BS: <input type="number" name="def_bs" value="30" min="0" max="100"/></label>
        <label>TO: <input type="number" name="def_to" value="20" min="0" max="100"/></label>
        <label>PF: <input type="number" name="def_pf" value="10" min="0" max="100"/></label>
        <div>Sum: <span id="sum_def">100</span></div>
      </div>
    </div>

    <button id="generateBtn">Generate Rankings</button>
    <div id="errorMsg" style="color:#f55; margin:10px 0;"></div>

    <div id="rankingMatrix"></div>
  </div>

  <script>
    let originalData = [];
    fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTdFDyDmOtmFl1uhz2ZJkhb0rb6BjWabVdhvrwn6DZ9DRAhEdwKhvkZ_dGQVwBrs1qrTtJQiHf-JEyU/pub?output=csv')
      .then(r => r.text()).then(csv => {
        Papa.parse(csv, { header:true, skipEmptyLines:true }).data.forEach(r => {
          originalData.push({
            player:r['Player'], competition:r['Competition'], year:parseInt(r['Year']),
            team:r['Team'], pts:+r['PTS'], as:+r['AS'], fgm:+r['FGM'], reb:+r['TR'],
            st:+r['ST'], bs:+r['BS'], to:+r['TO'], pf:+r['PF']
          });
        });
      });

    function sumWeights(prefix) {
      return ['pts','as','fgm','reb','st','bs','to','pf']
        .reduce((s, stat) => {
          const el = document.querySelector(`input[name="${prefix}_${stat}"]`);
          return el ? s + Number(el.value) : s;
        },0);
    }

    function readWeights(prefix, stats) {
      const w = {};
      let total = 0;
      stats.forEach(stat => {
        const val = Number(document.querySelector(`input[name="${prefix}_${stat}"]`).value);
        w[stat] = val;
        total += val;
      });
      return stats.map(stat => [stat, w[stat] / total]);
    }

    function validateAll() {
      const groups = ['guard','wings','center','def'];
      let ok = true;
      groups.forEach(g => {
        const s = sumWeights(g);
        document.getElementById(`sum_${g}`).textContent = s;
        if (s !== 100) ok = false;
      });
      return ok;
    }

    function calculateScore(p, weights) {
      return weights.reduce((sum, [stat, w]) => sum + (p[stat]||0)*w, 0);
    }

    function generate() {
      document.getElementById('errorMsg').textContent = '';
      if (!validateAll()) {
        document.getElementById('errorMsg').textContent = '⚠️ Each group must sum to 100.';
        return;
      }

      const comp = document.getElementById('competitionSelect').value;
      const year = document.getElementById('yearSelect').value;
      let data = originalData.slice();
      if (comp !== 'All') data = data.filter(p => p.competition === comp);
      if (year !== 'All') data = data.filter(p => p.year.toString() === year);

      const config = {
        guard: readWeights('guard',['pts','as','fgm','to']),
        wings: readWeights('wings',['pts','reb','fgm','st']),
        center: readWeights('center',['reb','bs','pts','pf']),
        def:    readWeights('def',['st','bs','to','pf'])
      };

      const container = document.getElementById('rankingMatrix');
      container.innerHTML = '';
      ['guard','wings','center','def'].forEach(pos => {
        const weights = config[pos];
        const sorted = data.map(p => ({
          player:p.player, team:p.team, score:calculateScore(p,weights)
        })).sort((a,b)=>b.score-a.score).slice(0,10);

        const tbl = document.createElement('table');
        tbl.innerHTML = `
          <thead><tr><th>${pos.toUpperCase()}</th><th>Team</th><th>Score</th></tr></thead>
          <tbody>${sorted.map(p=>`
            <tr><td>${p.player}</td><td>${p.team}</td><td>${p.score.toFixed(2)}</td></tr>`).join('')}</tbody>`;
        container.appendChild(tbl);
      });
    }

    document.getElementById('generateBtn').onclick = generate;
    ['guard','wings','center','def'].forEach(g => {
      ['pts','as','fgm','reb','st','bs','to','pf'].forEach(stat => {
        const el = document.querySelector(`input[name="${g}_${stat}"]`);
        if (el) el.oninput = () => document.getElementById(`sum_${g}`).textContent = sumWeights(g);
      });
    });
  </script>
</body>
</html>
