<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Advanced Weight Calculator</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="top-nav"> … </div>
  <div class="sub-nav"> … </div>

  <div class="container">
    <h1>Weighted Rankings</h1>

    <div class="filter-bar">
      <label>Competition:</label>
      <select id="competitionSelect" multiple size="3"></select>

      <label>Year:</label>
      <select id="yearSelect" multiple size="3">
        <option>All</option>
        <option>2024</option>
        <option>2025</option>
      </select>
    </div>

    <div class="weight-panel">
      <h2>Weight Allocation</h2>
      <div class="stats-select">
        <label><input type="checkbox" name="stat" value="pts"> Points (PTS)</label>
        <label><input type="checkbox" name="stat" value="as"> Assists (AS)</label>
        <label><input type="checkbox" name="stat" value="fgm"> FG Made (FGM)</label>
        <label><input type="checkbox" name="stat" value="st"> Steals (ST)</label>
      </div>

      <div class="name-input">
        <label>Allocation Name:
          <input type="text" id="allocName" placeholder="Scoring Focus">
        </label>
      </div>

      <div id="sliderContainer"></div>

      <button id="generateBtn">Generate Rankings</button>

      <h2 id="rankingTitle"></h2>
      <div class="table-wrapper">
        <table id="rankingTable">
          <thead>
            <tr><th>Player</th><th>Team</th><th>Score</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
let originalData = [];

fetch('https://docs.google.com/.../pub?output=csv')
  .then(r => r.text())
  .then(csv => {
    Papa.parse(csv, { header:true, skipEmptyLines:true }).data.forEach(r => {
      originalData.push({
        player: r['Player'],
        competition: r['Competition'],
        year: r['Year'],
        team: r['Team'],
        pts: +r['PTS'],
        as: +r['AS'],
        fgm: +r['FGM'],
        st: +r['ST']
      });
    });
    populateCompetitionOptions();
  });

function populateCompetitionOptions(){
  const compSet = new Set(originalData.map(p=>p.competition));
  const sel = document.getElementById('competitionSelect');
  sel.innerHTML = '<option>All</option>';
  compSet.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  });
}

function getSelectValues(select) {
  return Array.from(select.selectedOptions).map(o => o.value);
}

function getSelectedStats() {
  return Array.from(document.querySelectorAll('input[name="stat"]:checked'))
    .map(c => c.value);
}

function renderSliders() {
  const stats = getSelectedStats();
  const container = document.getElementById('sliderContainer');
  container.innerHTML = '';
  if (!stats.length) return;

  container.innerHTML = '<h3>Weight Allocation (Total = 100%)</h3>';
  stats.forEach(stat => {
    const div = document.createElement('div');
    const init = Math.floor(100 / stats.length);
    div.innerHTML = `
      <label style="display:flex; justify-content:space-between; margin-bottom:8px;">
        ${stat.toUpperCase()}:
        <input type="range" name="w_${stat}" min="0" max="100" value="${init}" oninput="rebalance('${stat}')">
        <span>${init}</span>%
      </label>`;
    container.appendChild(div);
  });
}

function rebalance(changed) {
  const sliders = document.querySelectorAll('#sliderContainer input[type=range]');
  const changedEl = document.querySelector(`[name=w_${changed}]`);
  const changedVal = +changedEl.value;

  const others = Array.from(sliders).filter(s => s !== changedEl);
  const totalOthers = others.reduce((sum,s) => sum + +s.value, 0);

  const remaining = 100 - changedVal;
  if (totalOthers > 0) {
    others.forEach(s => {
      const ratio = +s.value / totalOthers;
      s.value = Math.round(ratio * remaining);
    });
  } else {
    const share = Math.floor(remaining / others.length);
    others.forEach(s => s.value = share);
  }

  updateLabels();
}

function updateLabels() {
  document.querySelectorAll('#sliderContainer input[type=range]').forEach(inp => {
    inp.nextElementSibling.textContent = inp.value;
  });
}

function generateRanking() {
  const compVals = getSelectValues(document.getElementById('competitionSelect'));
  const yearVals = getSelectValues(document.getElementById('yearSelect'));
  const stats = getSelectedStats();

  if (!stats.length) {
    alert('Select at least one stat');
    return;
  }

  renderSliders();
  updateLabels();

  const weights = {};
  document.querySelectorAll('#sliderContainer input[type=range]')
    .forEach(inp => {
      weights[inp.name.replace('w_','')] = +inp.value / 100;
    });

  let data = originalData.slice();
  if (!compVals.includes('All')) {
    data = data.filter(p => compVals.includes(p.competition));
  }
  if (!yearVals.includes('All')) {
    data = data.filter(p => yearVals.includes(p.year));
  }

  const entries = data.map(p => ({
    player: p.player,
    team: p.team,
    score: stats.reduce((s, stat) => s + (p[stat] || 0) * weights[stat], 0)
  }))
  .sort((a,b) => b.score - a.score)
  .slice(0, 10);

  document.getElementById('rankingTitle').textContent =
    document.getElementById('allocName').value.trim() || 'Custom Allocation';

  const tbody = document.querySelector('#rankingTable tbody');
  tbody.innerHTML = entries
    .map(e => `<tr><td>${e.player}</td><td>${e.team}</td><td>${e.score.toFixed(2)}</td></tr>`)
    .join('');
}

document.querySelectorAll('input[name="stat"]').forEach(c =>
  c.addEventListener('change', renderSliders));
document.getElementById('generateBtn').addEventListener('click', generateRanking);
</script>
</body>
</html>
