<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Advanced Weight Calculator</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
</head>
<body>
  <!-- nav bar -->
  <div class="top-nav">
    <div class="left-section">
      <a href="https://www.maba.com.my" target="_blank" style="color: #333; text-decoration: none;">MABA</a>
      <span>FIBA</span>
    </div>
    <div class="right-section">
      <span>Listen</span>
      <span>Search üîç</span>
      <span>üë§</span>
    </div>
  </div>
  
  <!-- Sub-nav with dropdown -->
  <div class="sub-nav">
    <a href="index.html">Home</a>
    <a href="historical.html">Historical Stats</a>
    <a href="calculator.html">Advanced Calculator</a>
    <div class="dropdown">
      <a href="#" class="dropbtn">Competition ‚ñº</a>
      <div class="dropdown-content">
        <a href="#">MABA Cup</a>
        <a href="#">National U17</a>
        <a href="#">National U15</a>
        <a href="#">Agong Cup</a>
      </div>
    </div>
  </div>

  <div class="container">
    <h1>Weighted Rankings</h1>

    <div class="filter-bar">
      <label>Competition:</label>
      <select id="competitionSelect" multiple size="3">
        <option>All</option>
        <option>U15 (Boys)</option>
        <option>U17 (Boys)</option>
      </select>

      <label>Year:</label>
      <select id="yearSelect" multiple size="3">
        <option>All</option>
        <option>2024</option>
        <option>2025</option>
      </select>
    </div>

    <div class="weight-panel">
      <h2>Weight Allocation</h2>
      <div class="stats-select">
        <label><input type="checkbox" name="stat" value="fg"> FG% </label>
        <label><input type="checkbox" name="stat" value="fg2"> 2FG% </label>
        <label><input type="checkbox" name="stat" value="fg3"> 3FG% </label>
        <label><input type="checkbox" name="stat" value="ft"> FT% </label>
        <label><input type="checkbox" name="stat" value="oreb"> Offensive Rebounds </label>
        <label><input type="checkbox" name="stat" value="dreb"> Defensive Rebounds </label>
        <label><input type="checkbox" name="stat" value="treb"> Total Rebounds </label>
        <label><input type="checkbox" name="stat" value="as"> Assists </label>
        <label><input type="checkbox" name="stat" value="to"> Turnovers </label>
        <label><input type="checkbox" name="stat" value="st"> Steals </label>
        <label><input type="checkbox" name="stat" value="bs"> Blocked Shots </label>
        <label><input type="checkbox" name="stat" value="pf"> Personal Fouls </label>
        <label><input type="checkbox" name="stat" value="fd"> Fouls Drawn </label>
        <label><input type="checkbox" name="stat" value="pts"> Total Points </label>
      </div>

      <div class="name-input">
        <label>Allocation Name:
          <input type="text" id="allocName" placeholder="Scoring Focus">
        </label>
      </div>

      <div id="sliderContainer"></div>

      <button id="generateBtn">Generate Rankings</button>

      <h2 id="rankingTitle"></h2>
      <div class="table-wrapper">
        <table id="rankingTable">
          <thead>
            <tr><th>Player</th><th>Team</th><th>Score</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
let originalData = [];

// Fetch and parse CSV data
fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTdFDyDmOtmFl1uhz2ZJkhb0rb6BjWabVdhvrwn6DZ9DRAhEdwKhvkZ_dGQVwBrs1qrTtJQiHf-JEyU/pub?output=csv')
  .then(r => r.text())
  .then(csv => {
    const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true }).data;
    parsed.forEach(r => {
      originalData.push({
        player: r.Player,
        competition: r.Competition,
        year: r.Year,
        team: r.Team,
        gp: +r.GP,
        min: +r['Min'],
        fga: +r.FGA,
        fgm: +r.FGM,
        fga2: +r['2FGA'],
        fgm2: +r['2FGM'],
        fga3: +r['3FGA'],
        fgm3: +r['3FGM'],
        fta: +r.FTA,
        ftm: +r.FTM,
        oreb: +r.OR,
        dreb: +r.DR,
        treb: +r.TR,
        as: +r.AS,
        to: +r.TO,
        st: +r.ST,
        bs: +r.BS,
        pf: +r.PF,
        fd: +r.FD,
        pts: +r.PTS,
        fg: safeDivide(+r.FGM, +r.FGA),
        fg2: safeDivide(+r['2FGM'], +r['2FGA']),
        fg3: safeDivide(+r['3FGM'], +r['3FGA']),
        ft: safeDivide(+r.FTM, +r.FTA)
      });
    });
    populateCompetitionOptions();
  })
  .catch(err => {
    console.error("Error loading CSV:", err);
    alert("Failed to load player data.");
  });

// Populate dropdown with unique competition values
function populateCompetitionOptions() {
  const sel = document.getElementById('competitionSelect');
  sel.innerHTML = '<option>All</option>';
  [...new Set(originalData.map(p => p.competition))].forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  });
}

function getSelectValues(sel) {
  return [...sel.selectedOptions].map(o => o.value);
}

function getSelectedStats() {
  return [...document.querySelectorAll('input[name="stat"]:checked')].map(c => c.value);
}

// Renders sliders dynamically based on selected stats
function renderSliders() {
  const stats = getSelectedStats();
  const container = document.getElementById('sliderContainer');
  container.innerHTML = '';
  if (!stats.length) return;

  container.innerHTML = '<h3>Weight Allocation (Total =‚ÄØ100%)</h3>';
  stats.forEach(s => {
    const init = Math.floor(100 / stats.length);
    container.insertAdjacentHTML('beforeend', `
      <label style="display:flex; justify-content:space-between; margin-bottom:8px;">
        ${s.toUpperCase()}:
        <input type="range" name="w_${s}" min="0" max="100" value="${init}" oninput="rebalance('${s}')">
        <span>${init}</span>%
      </label>
    `);
  });
  document.getElementById('sliderContainer').style.display = 'block';
  updateLabels();
}

function rebalance(changed) {
  const all = document.querySelectorAll('#sliderContainer input[type="range"]');
  const changedEl = document.querySelector(`[name=w_${changed}]`);
  const cv = +changedEl.value;
  const others = [...all].filter(s => s !== changedEl);
  let remaining = 100 - cv;

  if (remaining < 0) remaining = 0;

  const sumOthers = others.reduce((sum, s) => sum + +s.value, 0);

  if (sumOthers === 0) {
    // Evenly distribute if all others were 0
    const even = Math.floor(remaining / others.length);
    others.forEach(s => s.value = even);
  } else {
    // Redistribute proportionally
    others.forEach(s => {
      const v = +s.value;
      const ratio = v / sumOthers;
      s.value = Math.round(ratio * remaining);
    });
  }

  // Fix any rounding errors
  let total = [...all].reduce((sum, s) => sum + +s.value, 0);
  if (total !== 100) {
    const delta = 100 - total;
    const firstOther = others[0];
    if (firstOther) {
      firstOther.value = +firstOther.value + delta;
    }
  }

  updateLabels();
}

function updateLabels() {
  document.querySelectorAll('#sliderContainer input[type=range]').forEach(inp => {
    inp.nextElementSibling.textContent = inp.value;
  });
}

// Generate top 10 ranking
function generateRanking() {
  const compSel = document.getElementById('competitionSelect');
  const yearSel = document.getElementById('yearSelect');
  const comps = getSelectValues(compSel);
  const years = getSelectValues(yearSel);
  const stats = getSelectedStats();

  if (!stats.length) return alert('Select at least one stat.');

  const weights = {};
  document.querySelectorAll('#sliderContainer input[type=range]').forEach(inp => {
    const stat = inp.name.replace('w_', '');
    weights[stat] = (stat === 'to' || stat === 'pf') ? -inp.value / 100 : +inp.value / 100;
  });

  let data = originalData.filter(p =>
    p.gp > 0 &&
    (!comps.includes('All') ? comps.includes(p.competition) : true) &&
    (!years.includes('All') ? years.includes(p.year) : true)
  );

  const entries = data.map(p => ({
    player: p.player,
    team: p.team,
    score: p.gp > 0
      ? stats.reduce((s, stat) => s + (p[stat] || 0) * weights[stat] / p.gp, 0)
      : 0
  }))
  .sort((a, b) => b.score - a.score)
  .slice(0, 10);

  document.getElementById('rankingTitle').textContent =
    document.getElementById('allocName').value.trim() || 'Ranking';

  const tbody = document.querySelector('#rankingTable tbody');
  tbody.innerHTML = entries
    .map(e => `<tr><td>${e.player}</td><td>${e.team}</td><td>${e.score.toFixed(2)}</td></tr>`)
    .join('');
}

function safeDivide(numerator, denominator) {
  return denominator === 0 ? 0 : numerator / denominator;
}

// Event bindings after DOM loads
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('input[name="stat"]').forEach(c =>
    c.addEventListener('change', renderSliders)
  );

  document.getElementById('generateBtn').addEventListener('click', generateRanking);
});
</script>
</body>
</html>
