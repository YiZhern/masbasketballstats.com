<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF‚Äë8" />
  <meta name="viewport" content="width=device‚Äëwidth, initial‚Äëscale=1.0" />
  <title>Player Analysis</title>
  <link rel="stylesheet" href="player_style.css" />
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- nav bar -->
  <div class="top-nav">
    <div class="left-section">
      <a href="https://maba.web.geniussports.com/" target="_blank" style="color: #333; text-decoration: none;">MABA</a>
      <span>FIBA</span>
    </div>
    <div class="right-section">
      <span>Listen</span>
      <span>Search üîç</span>
      <span>üë§</span>
    </div>
  </div>

  <!-- Sub-nav with dropdown -->
  <div class="sub-nav">
    <a href="index.html">Home</a>
    <a href="historical.html">Historical Stats</a>
    <a href="calculator.html">Advanced Calculator</a>
    <a href="player.html">Player Analysis</a>
    <div class="dropdown">
      <a href="#" class="dropbtn">Competition ‚ñº</a>
      <div class="dropdown-content">
        <a href="#">MABA Cup</a>
        <a href="#">National U17</a>
        <a href="#">National U15</a>
        <a href="#">Agong Cup</a>
      </div>
    </div>
  </div>

  <div class="container">
    <h1>Player Stats Lookup</h1>
    <div class="filter-bar">
      <input type="text" id="searchPlayer" placeholder="Enter player name..." oninput="showSuggestions()" autocomplete="off" />
      <div id="suggestions" class="suggestion-list"></div>
      <button type="button" onclick="searchPlayer()">Search</button>
    </div>

    <div id="tableContainer" class="table-wrapper" style="display:none;">
      <table id="playerStatsTable">
        <thead>
          <tr>
            <th>Player</th><th>Competition</th><th>Year</th><th>Team</th>
            <th>GP</th><th>Min</th><th>PTS</th><th>AS</th><th>TR</th><th>ST</th><th>BS</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr class="totals-row">
            <td colspan="4">Totals</td>
            <td id="tot-gp"></td><td id="tot-min"></td>
            <td id="tot-pts"></td><td id="tot-as"></td><td id="tot-tr"></td>
            <td id="tot-st"></td><td id="tot-bs"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Percentile Chart Section -->
    <div id="percentileSection" style="max-width: 800px; margin: 40px auto; display: none;">
      <h2 style="text-align: center;">Player Stat Percentiles</h2>
      <canvas id="percentileChart"></canvas>
    </div>
  </div>

  <script>
  let originalData = [];
  
  fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTdFDyDmOtmFl1uhz2ZJkhb0rb6BjWabVdhvrwn6DZ9DRAhEdwKhvkZ_dGQVwBrs1qrTtJQiHf-JEyU/pub?output=csv')
    .then(r => r.text())
    .then(csv => {
      const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true }).data;
      originalData = parsed.map(r => ({
        player: r.Player,
        competition: r.Competition,
        year: r.Year,
        team: r.Team,
        gp: +r.GP || 0,
        min: +r.Min || 0,
        pts: +r.PTS || 0,
        as: +r.AS || 0,
        tr: +r.TR || 0,
        st: +r.ST || 0,
        bs: +r.BS || 0
      }));
    });
  
  function showSuggestions() {
    const input = document.getElementById('searchPlayer').value.toLowerCase();
    const suggestionsDiv = document.getElementById('suggestions');
    suggestionsDiv.innerHTML = '';
  
    if (input.length === 0) return;
  
    const players = [...new Set(originalData.map(r => r.player))];
    const matches = players.filter(name => name.toLowerCase().includes(input));
  
    matches.forEach(name => {
      const div = document.createElement('div');
      div.textContent = name;
      div.onclick = () => {
        document.getElementById('searchPlayer').value = name;
        suggestionsDiv.innerHTML = '';
        searchPlayer();
      };
      suggestionsDiv.appendChild(div);
    });
  }
  
  function searchPlayer() {
    const nameInput = document.getElementById('searchPlayer').value.trim().toLowerCase();
    const filtered = originalData.filter(r => r.player.toLowerCase() === nameInput);
  
    if (filtered.length === 0) {
      document.getElementById('tableContainer').style.display = 'none';
      document.getElementById('percentileSection').style.display = 'none';
      return;
    }
  
    const tbody = document.querySelector('#playerStatsTable tbody');
    tbody.innerHTML = '';
  
    let totals = { gp: 0, min: 0, pts: 0, as: 0, tr: 0, st: 0, bs: 0 };
  
    filtered.forEach(r => {
      tbody.innerHTML += `
        <tr>
          <td>${r.player}</td>
          <td>${r.competition}</td>
          <td>${r.year}</td>
          <td>${r.team}</td>
          <td>${r.gp}</td>
          <td>${r.min}</td>
          <td>${r.pts}</td>
          <td>${r.as}</td>
          <td>${r.tr}</td>
          <td>${r.st}</td>
          <td>${r.bs}</td>
        </tr>
      `;
  
      totals.gp += Number(r.gp);
      totals.min += Number(r.min);
      totals.pts += Number(r.pts);
      totals.as += Number(r.as);
      totals.tr += Number(r.tr);
      totals.st += Number(r.st);
      totals.bs += Number(r.bs);
    });
  
    document.getElementById('tot-gp').textContent = totals.gp;
    document.getElementById('tot-min').textContent = totals.min;
    document.getElementById('tot-pts').textContent = totals.pts;
    document.getElementById('tot-as').textContent = totals.as;
    document.getElementById('tot-tr').textContent = totals.tr;
    document.getElementById('tot-st').textContent = totals.st;
    document.getElementById('tot-bs').textContent = totals.bs;
  
    document.getElementById('tableContainer').style.display = 'block';
  
    // Only generate chart if there are games
    if (totals.gp > 0) {
      const avgStats = {
        PTS: totals.pts / totals.gp,
        AS: totals.as / totals.gp,
        TR: totals.tr / totals.gp,
        ST: totals.st / totals.gp,
        BS: totals.bs / totals.gp,
        Min: totals.min / totals.gp,
      };
      showPercentiles(filtered[0].player, avgStats);
    }
  }
  
  function showPercentiles(playerName, stats) {
    console.log('showPercentiles called with:', playerName, stats);
  
    const canvas = document.getElementById('percentileChart');
    if (!canvas) {
      console.error('Canvas element not found');
      return;
    }
  
    const ctx = canvas.getContext('2d');
    if (!ctx) {
      console.error('Unable to get canvas context');
      return;
    }
  
    const labels = ['PTS', 'AS', 'TR', 'ST', 'BS', 'Min'];
    const values = [stats.PTS, stats.AS, stats.TR, stats.ST, stats.BS, stats.Min];
    console.log('Chart values:', values);
  
    if (window.percentileChart) {
      window.percentileChart.destroy();
    }
  
    window.percentileChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: `${playerName} (Avg Per Game)`,
          data: values,
          backgroundColor: 'rgba(75, 192, 192, 0.6)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Avg Per Game'
            }
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
  
    document.getElementById('percentileSection').style.display = 'block';
  }
  </script>
</body>
</html>
